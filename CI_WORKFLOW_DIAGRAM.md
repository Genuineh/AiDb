# CI/CD å·¥ä½œæµç¨‹å›¾

## æ–°çš„æ™ºèƒ½CIæµç¨‹

```
                                 GitHub Event
                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                   â”‚
                Push to                              PR to main
                  main                          (ready_for_review)
                    â”‚                                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Changes Job     â”‚ â­ æ™ºèƒ½æ£€æµ‹
                            â”‚  (dorny/filter)  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                         â”‚
                   Code = true               Code = false
                   Docs = ?                  Docs = true
                        â”‚                         â”‚
                        â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Run ALL Code Tests       â”‚    â”‚  docs-check      â”‚
        â”‚  â”œâ”€ test (matrix 9x)      â”‚    â”‚  (å¿«é€ŸéªŒè¯)       â”‚
        â”‚  â”œâ”€ clippy                â”‚    â”‚  ~30 ç§’ âš¡        â”‚
        â”‚  â”œâ”€ fmt                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚  â”œâ”€ coverage              â”‚             â”‚
        â”‚  â”œâ”€ build                 â”‚             â”‚
        â”‚  â””â”€ bench                 â”‚             â”‚
        â”‚                           â”‚             â”‚
        â”‚  ~15-20 åˆ†é’Ÿ              â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                      â”‚                           â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   ci-success     â”‚ â­ ç»Ÿä¸€æ£€æŸ¥ç‚¹
                      â”‚  (always run)    â”‚
                      â”‚                  â”‚
                      â”‚  æ™ºèƒ½åˆ¤æ–­:        â”‚
                      â”‚  â€¢ Code â†’ æ£€æŸ¥   â”‚
                      â”‚    æ‰€æœ‰ä»£ç jobs  â”‚
                      â”‚  â€¢ Docs â†’ åªæ£€æŸ¥ â”‚
                      â”‚    æ–‡æ¡£job       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚
                   âœ… Pass              âŒ Fail
                    â”‚                     â”‚
                    â–¼                     â–¼
            å¯ä»¥åˆå¹¶åˆ°main          éœ€è¦ä¿®å¤é—®é¢˜
```

## åœºæ™¯å¯¹æ¯”

### åœºæ™¯ A: çº¯æ–‡æ¡£æ›´æ–° ğŸ“

```
å¼€å‘è€…æäº¤
    â”‚
    â”œâ”€ ä¿®æ”¹ README.md
    â”œâ”€ ä¿®æ”¹ docs/ARCHITECTURE.md
    â””â”€ ä¿®æ”¹ CHANGELOG.md
    â”‚
    â–¼
åˆ›å»º PR â†’ Ready for Review
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CI Pipeline (æ™ºèƒ½æ£€æµ‹)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ changes        (~5s)                  â”‚
â”‚ âŠ˜ test           (è·³è¿‡)                 â”‚
â”‚ âŠ˜ clippy         (è·³è¿‡)                 â”‚
â”‚ âŠ˜ fmt            (è·³è¿‡)                 â”‚
â”‚ âŠ˜ coverage       (è·³è¿‡)                 â”‚
â”‚ âŠ˜ build          (è·³è¿‡)                 â”‚
â”‚ âŠ˜ bench          (è·³è¿‡)                 â”‚
â”‚ âœ“ docs-check     (~20s)                 â”‚
â”‚ âœ“ ci-success     (~5s)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
æ€»è€—æ—¶: ~30ç§’ âš¡
èŠ‚çœ: 97% (vs 15-20åˆ†é’Ÿ)
```

### åœºæ™¯ B: ä»£ç å¼€å‘ ğŸ’»

```
å¼€å‘è€…æäº¤
    â”‚
    â”œâ”€ ä¿®æ”¹ src/lib.rs
    â”œâ”€ æ·»åŠ  tests/integration.rs
    â””â”€ æ›´æ–° Cargo.toml
    â”‚
    â–¼
åˆ›å»º PR â†’ Ready for Review
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CI Pipeline (å®Œæ•´æµ‹è¯•)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ changes        (~5s)                  â”‚
â”‚ âœ“ test           (~12min, 9 matrix)     â”‚
â”‚ âœ“ clippy         (~2min)                â”‚
â”‚ âœ“ fmt            (~30s)                 â”‚
â”‚ âœ“ coverage       (~3min)                â”‚
â”‚ âœ“ build          (~2min)                â”‚
â”‚ âœ“ bench          (~1min)                â”‚
â”‚ âŠ˜ docs-check     (è·³è¿‡)                 â”‚
â”‚ âœ“ ci-success     (~5s)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
æ€»è€—æ—¶: ~15-20åˆ†é’Ÿ
èŠ‚çœ: 0% (ä¿æŒå®Œæ•´æµ‹è¯•ï¼Œä¿è¯è´¨é‡)
```

### åœºæ™¯ C: Draft PR å¼€å‘ ğŸš§

```
å¼€å‘è€…æäº¤
    â”‚
    â”œâ”€ ä¿®æ”¹ src/lib.rs (WIP)
    â”œâ”€ å¤šæ¬¡ commit & push
    â””â”€ æŒç»­å¼€å‘ä¸­...
    â”‚
    â–¼
åˆ›å»º Draft PR
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CI Pipeline                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (ä¸è¿è¡Œ)                                â”‚
â”‚                                         â”‚
â”‚ æ‰€æœ‰ jobs è·³è¿‡                          â”‚
â”‚                                         â”‚
â”‚ ç­‰å¾…æ ‡è®°ä¸º "Ready for review"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
æ€»è€—æ—¶: 0åˆ†é’Ÿ âš¡
èŠ‚çœ: 100%
å¼€å‘è€…å¯ä»¥è‡ªç”±æäº¤ï¼Œä¸æ¶ˆè€—CIèµ„æº
```

### åœºæ™¯ D: åŠŸèƒ½åˆ†æ”¯å¼€å‘ ğŸŒ¿

```
å¼€å‘è€…åœ¨åŠŸèƒ½åˆ†æ”¯
    â”‚
    â”œâ”€ feature/new-wal-format
    â”œâ”€ å¤šæ¬¡ commit & push
    â””â”€ æŒç»­å¼€å‘ä¸­...
    â”‚
    â–¼
Push to feature branch
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CI Pipeline                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (ä¸è¿è¡Œ)                                â”‚
â”‚                                         â”‚
â”‚ åªåœ¨ main åˆ†æ”¯è§¦å‘                      â”‚
â”‚                                         â”‚
â”‚ ç­‰å¾…åˆ›å»º PR                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
æ€»è€—æ—¶: 0åˆ†é’Ÿ âš¡
èŠ‚çœ: 100%
```

## Job ä¾èµ–å…³ç³»å›¾

```
             changes (æ£€æµ‹å˜æ›´)
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
   Code=true          Code=false
        â”‚             Docs=true
        â”‚                   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚        â”‚          â”‚        â”‚         â”‚        â”‚
        â–¼        â–¼          â–¼        â–¼         â–¼        â–¼
      test   clippy      fmt    coverage   build   bench   docs-check
        â”‚        â”‚          â”‚        â”‚         â”‚        â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                               ci-success
                              (always run)
                                     â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚                 â”‚
                           âœ…                âŒ
                        Success           Failure
```

## æ–‡ä»¶åˆ†ç±»è§„åˆ™

### æ–‡æ¡£æ–‡ä»¶ ğŸ“š
è§¦å‘æ¡ä»¶: `needs.changes.outputs.docs_only == 'true' && code == 'false'`

```
**/*.md                      - æ‰€æœ‰ Markdown æ–‡ä»¶
docs/**                      - æ–‡æ¡£ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
LICENSE                      - è®¸å¯è¯æ–‡ä»¶
CHANGELOG.md                 - å˜æ›´æ—¥å¿—
README.md                    - é¡¹ç›®è¯´æ˜
.github/workflows/README.md  - å·¥ä½œæµè¯´æ˜
```

**è¿è¡Œ**: docs-check åªéªŒè¯æ–‡æ¡£å®Œæ•´æ€§

### ä»£ç æ–‡ä»¶ ğŸ’»
è§¦å‘æ¡ä»¶: `needs.changes.outputs.code == 'true'`

```
src/**                       - æºä»£ç 
tests/**                     - æµ‹è¯•ä»£ç 
benches/**                   - åŸºå‡†æµ‹è¯•
examples/**                  - ç¤ºä¾‹ä»£ç 
Cargo.toml                   - ä¾èµ–é…ç½®
Cargo.lock                   - ä¾èµ–é”å®š
deny.toml                    - Deny é…ç½®
.github/workflows/*.yml      - CI/CD é…ç½®
```

**è¿è¡Œ**: æ‰€æœ‰ä»£ç æµ‹è¯• (test, clippy, fmt, coverage, build, bench)

## åˆ†æ”¯ä¿æŠ¤å»ºè®®

åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®ï¼š

```
Settings â†’ Branches â†’ Branch protection rules â†’ main

å¿…éœ€çŠ¶æ€æ£€æŸ¥:
â˜‘ Require status checks to pass before merging
  â˜‘ CI Success  â† åªéœ€è¦è¿™ä¸€ä¸ªï¼

å…¶ä»–è®¾ç½®:
â˜‘ Require branches to be up to date
â˜‘ Require pull request reviews (1)
â˜‘ Dismiss stale PR reviews
â˜‘ Restrict who can push
```

**ä¸ºä»€ä¹ˆåªéœ€è¦ "CI Success"?**
- ci-success job ä¾èµ–æ‰€æœ‰å…¶ä»– jobs
- å®ƒä¼šæ™ºèƒ½åˆ¤æ–­å“ªäº› jobs åº”è¯¥è¿è¡Œ
- æä¾›ç»Ÿä¸€çš„çŠ¶æ€æ£€æŸ¥ç‚¹
- ç®€åŒ–åˆ†æ”¯ä¿æŠ¤é…ç½®

## æœ€ä½³å®è·µ

### 1. æ–‡æ¡£é©±åŠ¨å¼€å‘ ğŸ“–
ç°åœ¨æ›´æ–°æ–‡æ¡£å‡ ä¹æ˜¯å³æ—¶çš„ï¼ˆ30ç§’ï¼‰ï¼Œé¼“åŠ±ï¼š
- å…ˆå†™æ–‡æ¡£ï¼Œåå†™ä»£ç 
- é¢‘ç¹æ›´æ–°æ–‡æ¡£
- æ–‡æ¡£å’Œä»£ç åˆ†å¼€æäº¤ PR

### 2. Draft PR å·¥ä½œæµ ğŸš§
- å¼€å‘åˆæœŸä½¿ç”¨ Draft PR
- é¢‘ç¹ commit å’Œ pushï¼ˆä¸è§¦å‘ CIï¼‰
- å‡†å¤‡å¥½åæ ‡è®° "Ready for review"

### 3. æ··åˆå˜æ›´ç­–ç•¥ ğŸ”€
å¦‚æœåŒæ—¶ä¿®æ”¹ä»£ç å’Œæ–‡æ¡£ï¼š
- è€ƒè™‘åˆ†æˆä¸¤ä¸ª PR
- æ–‡æ¡£ PR å¯ä»¥å¿«é€Ÿåˆå¹¶
- ä»£ç  PR è¿›è¡Œè¯¦ç»†å®¡æŸ¥

### 4. æœ¬åœ°æµ‹è¯• ğŸ’»
åŠŸèƒ½åˆ†æ”¯å¼€å‘æ—¶ï¼Œå®šæœŸè¿è¡Œæœ¬åœ°æµ‹è¯•ï¼š
```bash
cargo test --all-features
cargo clippy --all-targets --all-features -- -D warnings
cargo fmt --all -- --check
```

## ç›‘æ§æŒ‡æ ‡

å»ºè®®è·Ÿè¸ªçš„æŒ‡æ ‡ï¼š

1. **CI è¿è¡Œæ—¶é—´**
   - æ–‡æ¡£ PR å¹³å‡æ—¶é—´
   - ä»£ç  PR å¹³å‡æ—¶é—´
   - æ€»ä½“ CI æ—¶é—´èŠ‚çœ

2. **CI è§¦å‘æ¬¡æ•°**
   - Draft PR è§¦å‘æ¬¡æ•°ï¼ˆåº”è¯¥ä¸º 0ï¼‰
   - åŠŸèƒ½åˆ†æ”¯ push è§¦å‘æ¬¡æ•°ï¼ˆåº”è¯¥ä¸º 0ï¼‰
   - æ–‡æ¡£ PR vs ä»£ç  PR æ¯”ä¾‹

3. **èµ„æºä½¿ç”¨**
   - CI åˆ†é’Ÿæ•°æ¶ˆè€—
   - æˆæœ¬èŠ‚çœä¼°ç®—

4. **å¼€å‘ä½“éªŒ**
   - PR åˆå¹¶é€Ÿåº¦
   - æ–‡æ¡£æ›´æ–°é¢‘ç‡
   - å¼€å‘è€…åé¦ˆ
