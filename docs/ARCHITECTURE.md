# AiDb æ¶æ„è®¾è®¡æ–‡æ¡£

## ç›®å½•

- [1. æ¶æ„æ¦‚è§ˆ](#1-æ¶æ„æ¦‚è§ˆ)
- [2. å•æœºç‰ˆæ¶æ„](#2-å•æœºç‰ˆæ¶æ„)
- [3. é›†ç¾¤ç‰ˆæ¶æ„](#3-é›†ç¾¤ç‰ˆæ¶æ„)
- [4. æ•°æ®æ¨¡å‹](#4-æ•°æ®æ¨¡å‹)
- [5. å…³é”®è®¾è®¡å†³ç­–](#5-å…³é”®è®¾è®¡å†³ç­–)

---

## 1. æ¶æ„æ¦‚è§ˆ

AiDbé‡‡ç”¨åˆ†é˜¶æ®µæ¼”è¿›çš„æ¶æ„è®¾è®¡ï¼š

```
é˜¶æ®µA-C: å•æœºç‰ˆLSM-Treeå¼•æ“
    â†“
é˜¶æ®µ1-2: æ·»åŠ RPCå’ŒCoordinator
    â†“
é˜¶æ®µ3-6: å®Œæ•´çš„åˆ†å¸ƒå¼é›†ç¾¤
```

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

**å€Ÿé‰´RocksDBä¼˜ç‚¹ï¼Œé¿å…å…¶å¤æ‚æ€§**

âœ… **å€Ÿé‰´**ï¼š
- æˆç†Ÿçš„LSM-Treeåˆ†å±‚æ¶æ„
- Leveled Compactionç­–ç•¥
- Bloom Filterä¼˜åŒ–
- ç»è¿‡éªŒè¯çš„æ–‡ä»¶æ ¼å¼

âŒ **é¿å…**ï¼š
- è¿‡åº¦å¤æ‚çš„é…ç½®ï¼ˆ200+ â†’ <20ï¼‰
- è‡ƒè‚¿çš„APIï¼ˆ100+ â†’ <30ï¼‰
- C++ä¾èµ–å’Œç¼–è¯‘é—®é¢˜
- ä¸å¿…è¦çš„ç‰¹æ€§ï¼ˆColumn Familiesç­‰ï¼‰

**åˆ›æ–°è®¾è®¡**ï¼š
- ğŸ†• Replicaä½œä¸ºç¼“å­˜å±‚è€Œéå®Œæ•´å‰¯æœ¬
- ğŸ†• å¼‚æ­¥å¤‡ä»½æ›¿ä»£å®æ—¶å¤åˆ¶
- ğŸ†• çœŸæ­£çš„æ°´å¹³æ‰©å±•èƒ½åŠ›

---

## 2. å•æœºç‰ˆæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DB API                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Write Path                    â”‚
â”‚  Client â†’ WAL â†’ MemTable â†’ Flush â†’ SSTable  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Read Path                     â”‚
â”‚  Client â†’ MemTable â†’ Imm â†’ Cache â†’ SSTable  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             Background Tasks                 â”‚
â”‚  â€¢ Flush (MemTable â†’ SSTable)               â”‚
â”‚  â€¢ Compaction (SSTable Merge)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶

#### WAL (Write-Ahead Log)
**èŒè´£**ï¼šç¡®ä¿æ•°æ®æŒä¹…åŒ–

```rust
// Recordæ ¼å¼ï¼ˆå€Ÿé‰´RocksDBï¼‰
[checksum: u32]  // CRC32æ ¡éªŒ
[length: u16]    // æ•°æ®é•¿åº¦  
[type: u8]       // FULL/FIRST/MIDDLE/LAST
[data: bytes]    // å®é™…æ•°æ®

// ç‰¹æ€§
- é¡ºåºè¿½åŠ å†™å…¥
- fsyncä¿è¯æŒä¹…åŒ–
- æ”¯æŒå´©æºƒæ¢å¤
- æ”¯æŒæ—¥å¿—è½®è½¬
```

#### MemTable
**èŒè´£**ï¼šå†…å­˜ä¸­çš„æœ‰åºç´¢å¼•

```rust
// æ•°æ®ç»“æ„
- SkipListï¼ˆä½¿ç”¨crossbeam-skiplistï¼‰
- å¹¶å‘å®‰å…¨ï¼ˆå¤šè¯»å•å†™ï¼‰
- å¤§å°é™åˆ¶ï¼ˆé»˜è®¤4MBï¼‰

// æ“ä½œ
- Put: O(log n)
- Get: O(log n)  
- Delete: å¢“ç¢‘æ ‡è®°
- Iterator: æœ‰åºéå†

// çŠ¶æ€è½¬æ¢
Mutable â†’ (Full) â†’ Immutable â†’ (Flush) â†’ Dropped
```

#### SSTable (Sorted String Table)
**èŒè´£**ï¼šç£ç›˜ä¸Šçš„æœ‰åºä¸å¯å˜æ–‡ä»¶

```rust
// æ–‡ä»¶æ ¼å¼
[Data Block 1]    // 4KB, KV pairs
[Data Block 2]
...
[Data Block N]
[Meta Block]      // Bloom Filter
[Index Block]     // Data Blockç´¢å¼•
[Footer: 48B]     // æŒ‡å‘Index Block

// ç‰¹æ€§
- ä¸å¯å˜ï¼ˆImmutableï¼‰
- åˆ†Blockå­˜å‚¨ï¼ˆ4KBï¼‰
- äºŒçº§ç´¢å¼•ï¼ˆIndex â†’ Dataï¼‰
- Bloom FilteråŠ é€ŸæŸ¥è¯¢
```

#### Compaction
**èŒè´£**ï¼šåˆå¹¶SSTableï¼Œå›æ”¶ç©ºé—´

```rust
// Leveled Compactionç­–ç•¥
Level 0: 4ä¸ªæ–‡ä»¶ï¼Œå¯èƒ½é‡å 
Level 1: 10MBï¼Œæœ‰åºä¸é‡å 
Level 2: 100MBï¼Œæœ‰åºä¸é‡å 
Level N: 10^N MB

// è§¦å‘æ¡ä»¶
- Level 0: æ–‡ä»¶æ•° >= 4
- Level N: æ€»å¤§å° >= é˜ˆå€¼

// æ‰§è¡Œè¿‡ç¨‹
1. é€‰æ‹©æ–‡ä»¶ï¼ˆLevel N + Level N+1é‡å ï¼‰
2. å¤šè·¯å½’å¹¶æ’åº
3. ç”Ÿæˆæ–°SSTable
4. æ›´æ–°Manifest
5. åˆ é™¤æ—§æ–‡ä»¶
```

### 2.3 æ•°æ®æµ

#### å†™å…¥è·¯å¾„
```
1. Client.put(key, value)
   â†“
2. WAL.append(record)
   â†“  
3. WAL.sync() (å¯é€‰)
   â†“
4. MemTable.put(key, value)
   â†“
5. Check MemTable size
   â†“ (if full)
6. Trigger Flush
   â†“
7. MemTable â†’ Immutable
   â†“
8. Create new MemTable
   â†“
9. Background: Flush Immutable â†’ SSTable
```

#### è¯»å–è·¯å¾„
```
1. Client.get(key)
   â†“
2. Check MemTable
   â†“ (if not found)
3. Check Immutable MemTables
   â†“ (if not found)
4. Check Block Cache
   â†“ (if miss)
5. For each level (0 â†’ N):
   a. Check Bloom Filter
   b. Binary search Index Block
   c. Read Data Block
   â†“
6. Return value or None
```

### 2.4 æ–‡ä»¶ç»„ç»‡

```
data_dir/
â”œâ”€â”€ LOCK              # è¿›ç¨‹é”
â”œâ”€â”€ CURRENT           # å½“å‰Manifest
â”œâ”€â”€ MANIFEST-000001   # å…ƒæ•°æ®æ—¥å¿—
â”œâ”€â”€ 000001.log        # WAL
â”œâ”€â”€ 000002.sst        # SSTable (Level 0)
â”œâ”€â”€ 000003.sst        # SSTable (Level 0)
â”œâ”€â”€ 000004.sst        # SSTable (Level 1)
â””â”€â”€ 000005.sst        # SSTable (Level 1)
```

---

## 3. é›†ç¾¤ç‰ˆæ¶æ„

### 3.1 æ•´ä½“æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Coordinator    â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚  Router      â”‚ â”‚
                    â”‚ â”‚  LB          â”‚ â”‚
                    â”‚ â”‚  Health      â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
         â”‚ Shard 1 â”‚    â”‚Shard 2 â”‚    â”‚Shard N â”‚
         â”‚  Group  â”‚    â”‚ Group  â”‚    â”‚ Group  â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” Ã— N
â”‚Primary â”‚   RPC    â”‚Replica â”‚
â”‚        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”â”‚          â”‚â”Œâ”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚Local â”‚â”‚          â”‚â”‚Cache â”‚â”‚
â”‚â”‚ SSD  â”‚â”‚          â”‚â”‚(LRU) â”‚â”‚
â”‚â”‚      â”‚â”‚          â”‚â””â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚â”‚LSM-  â”‚â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚â”‚Tree  â”‚â”‚
â”‚â””â”€â”€â”¬â”€â”€â”€â”˜â”‚
â”‚   â”‚å¼‚æ­¥ â”‚
â”‚   â–¼    â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚Backupâ”‚â”‚
â”‚â”‚ Mgr  â”‚â”‚
â”‚â””â”€â”€â”¬â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ S3/OSS  â”‚
â”‚ ç½‘ç›˜å¤‡ä»½ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒç»„ä»¶

#### Coordinator (åè°ƒå™¨)
**èŒè´£**ï¼šè·¯ç”±å’Œè´Ÿè½½å‡è¡¡

```rust
// åŠŸèƒ½
1. ä¸€è‡´æ€§å“ˆå¸Œè·¯ç”±
   - è™šæ‹ŸèŠ‚ç‚¹ï¼ˆé»˜è®¤150ä¸ª/shardï¼‰
   - å‡è¡¡åˆ†å¸ƒ
   - åŠ¨æ€æ·»åŠ /åˆ é™¤shard

2. è´Ÿè½½å‡è¡¡
   - å†™è¯·æ±‚ â†’ Primary
   - è¯»è¯·æ±‚ â†’ Replica (round-robin/least-conn)
   
3. å¥åº·æ£€æŸ¥
   - å®šæœŸæ£€æµ‹èŠ‚ç‚¹
   - è‡ªåŠ¨å‰”é™¤æ•…éšœèŠ‚ç‚¹
   - æ¢å¤åé‡æ–°åŠ å…¥

4. å…ƒæ•°æ®ç®¡ç†
   - Shardæ˜ å°„
   - èŠ‚ç‚¹çŠ¶æ€
   - é›†ç¾¤æ‹“æ‰‘
```

#### Primary Node (ä¸»èŠ‚ç‚¹)
**èŒè´£**ï¼šå®Œæ•´çš„æ•°æ®å­˜å‚¨

```rust
pub struct PrimaryNode {
    // å®Œæ•´çš„LSM-Tree DB
    db: DB,
    
    // RPCæœåŠ¡å™¨ï¼ˆä¾›Replicaè®¿é—®ï¼‰
    rpc_server: RpcServer,
    
    // å¤‡ä»½ç®¡ç†å™¨
    backup_manager: BackupManager,
}

// ç‰¹æ€§
- æœ¬åœ°SSDå­˜å‚¨ï¼ˆé«˜æ€§èƒ½ï¼‰
- æä¾›RPCæ¥å£
- å¤„ç†æ‰€æœ‰å†™å…¥
- å¤„ç†è¯»å–ï¼ˆå¦‚æœReplica missï¼‰
- å¼‚æ­¥å¤‡ä»½åˆ°ç½‘ç›˜
```

#### Replica Node (ä»èŠ‚ç‚¹)
**èŒè´£**ï¼šç¼“å­˜å±‚ + è¯·æ±‚è½¬å‘

```rust
pub struct ReplicaNode {
    // å†…å­˜LRUç¼“å­˜
    cache: LruCache<Vec<u8>, Vec<u8>>,
    
    // Primaryçš„RPCå®¢æˆ·ç«¯
    primary_client: RpcClient,
}

// ç‰¹æ€§
- åªæœ‰å†…å­˜ç¼“å­˜ï¼ˆè½»é‡çº§ï¼‰
- ç¼“å­˜å‘½ä¸­ â†’ ç›´æ¥è¿”å›ï¼ˆ< 0.1msï¼‰
- ç¼“å­˜miss â†’ è½¬å‘Primary
- æ— çŠ¶æ€ï¼Œå¯éšæ—¶é‡å¯
- ç§’çº§å¯åŠ¨
```

#### Backup Manager (å¤‡ä»½ç®¡ç†å™¨)
**èŒè´£**ï¼šå¼‚æ­¥å¤‡ä»½å’Œæ¢å¤

```rust
// å¤‡ä»½ç­–ç•¥
1. å¿«ç…§ï¼ˆSnapshotï¼‰
   - å®šæœŸï¼ˆå¦‚æ¯å°æ—¶ï¼‰
   - å®Œæ•´çš„SSTable + Manifest
   - ä¸Šä¼ åˆ°S3/OSS

2. WALå½’æ¡£
   - é¢‘ç¹ï¼ˆå¦‚æ¯10åˆ†é’Ÿï¼‰
   - å¢é‡å¤‡ä»½
   - ç¼©å°æ•°æ®ä¸¢å¤±çª—å£

// æ¢å¤æµç¨‹
1. ä¸‹è½½æœ€æ–°å¿«ç…§
2. æ¢å¤åˆ°æœ¬åœ°ç£ç›˜
3. Replayå¿«ç…§åçš„WAL
4. å¯åŠ¨DB
```

### 3.3 æ•°æ®åˆ†ç‰‡

#### ä¸€è‡´æ€§å“ˆå¸Œ
```rust
// åŸç†
1. æ„å»ºHashç¯ï¼ˆ0 ~ 2^64-1ï¼‰
2. æ¯ä¸ªshardæ˜ å°„åˆ°å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹
3. Keyå“ˆå¸Œåï¼Œé¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹
4. è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…shard

// ä¼˜åŠ¿
- æ·»åŠ /åˆ é™¤shardå½±å“æœ€å°
- è´Ÿè½½å‡è¡¡
- æ— éœ€æ•°æ®è¿ç§»ï¼ˆæ–°keyè‡ªåŠ¨è·¯ç”±ï¼‰
```

#### Shard Group
```rust
pub struct ShardGroup {
    shard_id: ShardId,
    key_range: Option<(Vec<u8>, Vec<u8>)>,
    
    // èŠ‚ç‚¹
    primary: PrimaryNode,
    replicas: Vec<ReplicaNode>,
    
    // çŠ¶æ€
    health: ShardHealth,
}

// æ•°æ®éš”ç¦»
- æ¯ä¸ªshardç‹¬ç«‹å­˜å‚¨
- shardä¹‹é—´ä¸å…±äº«æ•°æ®
- æ•…éšœéš”ç¦»
```

### 3.4 æ•°æ®æµ

#### å†™å…¥è·¯å¾„
```
1. Client â†’ Coordinator
   â†“
2. Coordinator.route(key) â†’ Shard X
   â†“
3. Shard X.Primary.put(key, value)
   â†“
4. Primaryå†™å…¥æœ¬åœ°DB
   â†“
5. è¿”å›æˆåŠŸ
   â†“
6. ï¼ˆå¼‚æ­¥ï¼‰å¤‡ä»½åˆ°ç½‘ç›˜
```

#### è¯»å–è·¯å¾„ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
```
1. Client â†’ Coordinator
   â†“
2. Coordinator.route(key) â†’ Shard X
   â†“
3. è´Ÿè½½å‡è¡¡ â†’ Replica Y
   â†“
4. Replica Y.cache.get(key)
   â†“ (hit)
5. è¿”å›value (< 0.1ms)
```

#### è¯»å–è·¯å¾„ï¼ˆç¼“å­˜missï¼‰
```
1. Client â†’ Coordinator
   â†“
2. Coordinator.route(key) â†’ Shard X
   â†“
3. è´Ÿè½½å‡è¡¡ â†’ Replica Y
   â†“
4. Replica Y.cache.get(key)
   â†“ (miss)
5. Replica Y â†’ RPC â†’ Primary
   â†“
6. Primary.db.get(key)
   â†“
7. è¿”å›value
   â†“
8. Replica Yæ›´æ–°ç¼“å­˜
   â†“
9. è¿”å›value (< 2ms)
```

### 3.5 é«˜å¯ç”¨è®¾è®¡

#### æ•…éšœåœºæ™¯å’Œå¤„ç†

| æ•…éšœç±»å‹ | å½±å“ | æ¢å¤æ–¹å¼ | æ¢å¤æ—¶é—´ |
|---------|------|---------|---------|
| Replicaæ•…éšœ | è¯»èƒ½åŠ›â†“ | è‡ªåŠ¨å‰”é™¤ï¼Œå¯åŠ¨æ–°Replica | ç§’çº§ |
| Primaryæ•…éšœ | å•shardä¸å¯å†™ | ä»å¤‡ä»½æ¢å¤ | 5-30åˆ†é’Ÿ |
| ç£ç›˜æŸå | å•shardæ•°æ®ä¸¢å¤± | ä»ç½‘ç›˜æ¢å¤ | 10-60åˆ†é’Ÿ |
| ç½‘ç»œåˆ†åŒº | éƒ¨åˆ†ä¸å¯è¾¾ | è‡ªåŠ¨é‡è¿ | è‡ªæ„ˆ |

#### æ•°æ®ä¸€è‡´æ€§

**æ¨¡å‹**ï¼šæœ€ç»ˆä¸€è‡´æ€§

```
Primaryå†™å…¥æˆåŠŸ â†’ ç«‹å³è¿”å›
   â†“
Replicaç¼“å­˜å¯èƒ½æœ‰å»¶è¿Ÿ
   â†“
ä½†æœ€ç»ˆä¼šä¸€è‡´ï¼ˆé€šè¿‡è½¬å‘åˆ°Primaryï¼‰

å¯æ¥å—åœºæ™¯ï¼š
- ç¼“å­˜å»¶è¿Ÿ < ç§’çº§
- ä¸éœ€è¦å¼ºä¸€è‡´æ€§
- é€šè¿‡è½¬å‘è·å–æœ€æ–°æ•°æ®
```

#### æ•°æ®ä¸¢å¤±çª—å£

```
å¿«ç…§é—´éš”: 1å°æ—¶
WALå½’æ¡£: 10åˆ†é’Ÿ
â†’ æœ€å¤§ä¸¢å¤±: 10åˆ†é’Ÿæ•°æ®

é€šè¿‡è°ƒæ•´é¢‘ç‡å¯è¿›ä¸€æ­¥é™ä½ï¼š
- å¿«ç…§: æ¯30åˆ†é’Ÿ
- WAL: æ¯5åˆ†é’Ÿ
â†’ æœ€å¤§ä¸¢å¤±: 5åˆ†é’Ÿ
```

---

## 4. æ•°æ®æ¨¡å‹

### 4.1 å†…éƒ¨é”®æ ¼å¼

```rust
// InternalKey
[user_key: bytes]    // ç”¨æˆ·key
[sequence: u64]      // åºåˆ—å·ï¼ˆå…¨å±€é€’å¢ï¼‰
[type: u8]          // Put=1, Delete=0

// æ’åºè§„åˆ™
1. user_keyå‡åº
2. sequenceé™åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
3. typeé™åºï¼ˆPutåœ¨Deleteå‰ï¼‰
```

### 4.2 SSTableæ ¼å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Data Block 1                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ KV Pair 1                   â”‚   â”‚
â”‚  â”‚ KV Pair 2                   â”‚   â”‚
â”‚  â”‚ ...                         â”‚   â”‚
â”‚  â”‚ Restart Points [4B Ã— N]     â”‚   â”‚
â”‚  â”‚ Num Restarts [4B]           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Data Block 2                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ...                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Meta Block                  â”‚
â”‚  (Bloom Filter)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Index Block                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Block 1: key, offset, size  â”‚   â”‚
â”‚  â”‚ Block 2: key, offset, size  â”‚   â”‚
â”‚  â”‚ ...                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Footer (48 bytes)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Meta Index Handle [20B]     â”‚   â”‚
â”‚  â”‚ Index Handle [20B]          â”‚   â”‚
â”‚  â”‚ Magic Number [8B]           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Manifestæ ¼å¼

```rust
// Manifestè®°å½•ç‰ˆæœ¬å˜æ›´
enum VersionEdit {
    // æ–°å¢æ–‡ä»¶
    AddFile {
        level: u32,
        file_number: u64,
        file_size: u64,
        smallest_key: Vec<u8>,
        largest_key: Vec<u8>,
    },
    
    // åˆ é™¤æ–‡ä»¶
    DeleteFile {
        level: u32,
        file_number: u64,
    },
    
    // è®¾ç½®åºåˆ—å·
    SetSequenceNumber(u64),
    
    // è®¾ç½®CompactionæŒ‡é’ˆ
    SetCompactionPointer {
        level: u32,
        key: Vec<u8>,
    },
}
```

---

## 5. å…³é”®è®¾è®¡å†³ç­–

### 5.1 ä¸ºä»€ä¹ˆé€‰æ‹©Replicaä½œä¸ºç¼“å­˜å±‚ï¼Ÿ

**å¯¹æ¯”ä¼ ç»Ÿå…¨é‡å¤åˆ¶**ï¼š

| ç»´åº¦ | å…¨é‡å¤åˆ¶ | ç¼“å­˜å±‚ |
|------|---------|--------|
| å­˜å‚¨æˆæœ¬ | 100GB Ã— 3 = 300GB | 100GB + 10GBç¼“å­˜ = 110GB |
| ç½‘ç»œæˆæœ¬ | å®æ—¶å¤åˆ¶å…¨é‡ | åªå¤åˆ¶çƒ­æ•°æ® |
| å¯åŠ¨æ—¶é—´ | éœ€è¦åŒæ­¥æ•°æ®ï¼ˆå°æ—¶çº§ï¼‰ | ç§’çº§ |
| æ‰©å±•æ€§ | å¤åˆ¶æ˜¯ç“¶é¢ˆ | çº¿æ€§æ‰©å±• |

**æˆ‘ä»¬çš„æ–¹æ¡ˆ**ï¼š
- 80%è¯»å–æ¥è‡ªç¼“å­˜ï¼ˆå‘½ä¸­ç‡ï¼‰
- 20%è½¬å‘åˆ°Primaryï¼ˆå¯æ¥å—ï¼‰
- æˆæœ¬é™ä½60%+
- æ‰©å±•æ€§æ›´å¥½

### 5.2 ä¸ºä»€ä¹ˆå¼‚æ­¥å¤‡ä»½è€Œéå®æ—¶å¤åˆ¶ï¼Ÿ

**é£é™©æƒè¡¡**ï¼š

```
å®æ—¶å¤åˆ¶ï¼š
+ æ•°æ®ä¸¢å¤±: 0
+ æˆæœ¬: é«˜ï¼ˆç½‘ç»œ+å­˜å‚¨ï¼‰
+ å¤æ‚åº¦: é«˜

å¼‚æ­¥å¤‡ä»½ï¼š
+ æ•°æ®ä¸¢å¤±: < 10åˆ†é’Ÿ
+ æˆæœ¬: ä½ï¼ˆæ‰¹é‡ä¸Šä¼ ï¼‰
+ å¤æ‚åº¦: ä½

ç”¨æˆ·åœºæ™¯ï¼š
- é™æµæªæ–½åšå¾—å¥½
- ä¸»è¦é˜²æ„å¤–è€Œéç¾éš¾
- å¯æ¥å—çŸ­æš‚ä¸¢å¤±
â†’ é€‰æ‹©å¼‚æ­¥å¤‡ä»½
```

### 5.3 ä¸ºä»€ä¹ˆReplicaé€šè¿‡RPCè€Œéå…±äº«æ–‡ä»¶ï¼Ÿ

**æŠ€æœ¯é—®é¢˜**ï¼š

å…±äº«æ–‡ä»¶æ–¹æ¡ˆï¼š
- âŒ LSM Compactionä¼šåˆ é™¤æ–‡ä»¶
- âŒ Manifestä¸ä¸€è‡´
- âŒ æ–‡ä»¶é”å†²çª
- âŒ é¡µç¼“å­˜é—®é¢˜

RPCæ–¹æ¡ˆï¼š
- âœ… æ— æ–‡ä»¶å†²çª
- âœ… å®ç°ç®€å•
- âœ… RPCå¼€é”€å°ï¼ˆå¾®ç§’çº§ï¼‰
- âœ… æ¸…æ™°çš„èŒè´£åˆ’åˆ†

### 5.4 ä¸ºä»€ä¹ˆç”¨æœ¬åœ°SSDè€Œéç½‘ç»œç›˜ï¼Ÿ

**æ€§èƒ½å¯¹æ¯”**ï¼š

| å­˜å‚¨ç±»å‹ | å»¶è¿Ÿ | IOPS | åå |
|---------|------|------|------|
| æœ¬åœ°SSD | < 0.1ms | 500K+ | 3GB/s |
| ç½‘ç»œç›˜(EBS) | 1-10ms | 10K-20K | 500MB/s |

**ç»“è®º**ï¼š
- Primaryç”¨æœ¬åœ°SSDï¼ˆæ€§èƒ½ï¼‰
- ç½‘ç›˜åªåšå¤‡ä»½ï¼ˆæˆæœ¬ï¼‰
- ä¸åœ¨çƒ­è·¯å¾„ä¸Š

### 5.5 ä¸ºä»€ä¹ˆå¤šShardè€Œéå•ä¸€å¤§èŠ‚ç‚¹ï¼Ÿ

**æ‰©å±•æ€§**ï¼š

```
å•èŠ‚ç‚¹ï¼š
- å†™å…¥: å—é™äºå•æœºæ€§èƒ½
- è¯»å–: å—é™äºå•æœºæ€§èƒ½
- å®¹é‡: å—é™äºå•æœºç£ç›˜

å¤šShardï¼š
- å†™å…¥: çº¿æ€§æ‰©å±•ï¼ˆN Ã— å•æœºï¼‰
- è¯»å–: çº¿æ€§æ‰©å±•
- å®¹é‡: è¿‘ä¹æ— é™
- æ•…éšœéš”ç¦»: å•shardæ•…éšœä¸å½±å“å…¶ä»–
```

---

## æ€»ç»“

AiDbçš„æ¶æ„è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **æ¸è¿›å¼æ¼”è¿›**ï¼šå•æœº â†’ é›†ç¾¤ï¼Œæ¯é˜¶æ®µç‹¬ç«‹å¯ç”¨
2. **æˆæœ¬ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶
3. **å®ç”¨ä¸»ä¹‰**ï¼šä¸è¿½æ±‚å®Œç¾ï¼Œæ»¡è¶³80%éœ€æ±‚
4. **Rustä¼˜åŠ¿**ï¼šç±»å‹å®‰å…¨ã€å†…å­˜å®‰å…¨ã€é«˜æ€§èƒ½
5. **å€Ÿé‰´ç»éªŒ**ï¼šå­¦ä¹ RocksDBæˆç†Ÿè®¾è®¡ï¼Œé¿å…å…¶å¤æ‚æ€§

æœ€ç»ˆç›®æ ‡ï¼šæ„å»ºä¸€ä¸ª**é«˜æ€§èƒ½ã€ä½æˆæœ¬ã€æ˜“æ‰©å±•**çš„åˆ†å¸ƒå¼KVå­˜å‚¨å¼•æ“ã€‚

---

æ›´å¤šæŠ€æœ¯ç»†èŠ‚è¯·å‚è€ƒï¼š
- [å®æ–½è®¡åˆ’](IMPLEMENTATION.md)
- [è®¾è®¡å†³ç­–](DESIGN_DECISIONS.md)
