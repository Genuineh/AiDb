name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # æ£€æµ‹æ–‡ä»¶å˜æ›´ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¿è¡Œä»£ç æµ‹è¯•
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs_only: ${{ steps.filter.outputs.docs_only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs_only:
              - '**/*.md'
              - 'docs/**'
              - 'LICENSE'
              - 'CHANGELOG.md'
              - 'README.md'
              - '.github/workflows/README.md'
            code:
              - 'src/**'
              - 'benches/**'
              - 'examples/**'
              - 'tests/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'deny.toml'
              - '.github/workflows/ci.yml'
              - '.github/workflows/security.yml'
              - '.github/workflows/release.yml'

  test:
    name: Test Suite
    needs: changes
    runs-on: ${{ matrix.os }}
    if: needs.changes.outputs.code == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta, nightly]
        exclude:
          # Reduce CI time by only testing nightly on Linux
          - os: macos-latest
            rust: nightly
          - os: windows-latest
            rust: nightly
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-${{ matrix.rust }}-

      - name: Run tests
        run: cargo test --all-features --verbose

      - name: Run doc tests
        run: cargo test --doc --all-features

  clippy:
    name: Clippy (Linting)
    needs: changes
    runs-on: ubuntu-latest
    if: needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  fmt:
    name: Format Check
    needs: changes
    runs-on: ubuntu-latest
    if: needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  coverage:
    name: Code Coverage
    needs: changes
    runs-on: ubuntu-latest
    if: needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate coverage
        run: cargo tarpaulin --all-features --workspace --timeout 300 --out xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: Build Check
    needs: changes
    runs-on: ubuntu-latest
    if: needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Build (debug)
        run: cargo build --all-features

      - name: Build (release)
        run: cargo build --release --all-features

      - name: Build examples
        run: cargo build --examples

  bench:
    name: Benchmark Check
    needs: changes
    runs-on: ubuntu-latest
    if: needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Check benchmarks compile
        run: cargo bench --no-run --all-features

  # æ–‡æ¡£æ£€æŸ¥ - åªåœ¨æ–‡æ¡£å˜æ›´æ—¶è¿è¡Œ
  docs-check:
    name: Documentation Check
    needs: changes
    runs-on: ubuntu-latest
    if: needs.changes.outputs.docs_only == 'true' && needs.changes.outputs.code == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check markdown files
        run: |
          echo "ğŸ“š Checking documentation files..."
          find . -name "*.md" -type f | while read file; do
            echo "âœ“ $file"
          done
          echo "âœ… Documentation check completed successfully"

      - name: Verify documentation structure
        run: |
          # æ£€æŸ¥é‡è¦æ–‡æ¡£æ˜¯å¦å­˜åœ¨
          required_docs=("README.md" "LICENSE" "CHANGELOG.md")
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ“ $doc exists"
            else
              echo "âš ï¸  $doc not found"
            fi
          done

  # CIçŠ¶æ€æ±‡æ€» - å¿…é¡»æ€»æ˜¯è¿è¡Œä»¥æä¾›ç»Ÿä¸€çš„çŠ¶æ€æ£€æŸ¥
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [changes, test, clippy, fmt, coverage, build, bench, docs-check]
    if: always()
    steps:
      - name: Check CI status
        run: |
          echo "=== CI Pipeline Status Summary ==="
          echo ""
          echo "Changes Detection: ${{ needs.changes.result }}"
          echo "Code Changes: ${{ needs.changes.outputs.code }}"
          echo "Docs Only: ${{ needs.changes.outputs.docs_only }}"
          echo ""
          
          # æ£€æŸ¥changes job - å¦‚æœè·³è¿‡ï¼ˆdraft PRï¼‰åˆ™è®¤ä¸ºæˆåŠŸ
          if [ "${{ needs.changes.result }}" == "failure" ]; then
            echo "âŒ Changes detection failed"
            exit 1
          elif [ "${{ needs.changes.result }}" == "skipped" ]; then
            echo "â­ï¸  CI skipped (draft PR or no trigger match)"
            echo "âœ… CI check passed (skipped)"
            exit 0
          fi
          
          # å¦‚æœæœ‰ä»£ç å˜æ›´ï¼Œæ£€æŸ¥ä»£ç ç›¸å…³çš„jobs
          if [ "${{ needs.changes.outputs.code }}" == "true" ]; then
            echo "ğŸ“Š Code Changes Detected - Checking all code jobs..."
            
            failed=0
            
            # æ£€æŸ¥æ¯ä¸ªjobçš„ç»“æœï¼Œåªæœ‰æ˜ç¡®å¤±è´¥æ‰ç®—å¤±è´¥ï¼ˆè·³è¿‡ä¸ç®—å¤±è´¥ï¼‰
            if [ "${{ needs.test.result }}" == "failure" ]; then
              echo "âŒ Tests failed"
              failed=1
            fi
            
            if [ "${{ needs.clippy.result }}" == "failure" ]; then
              echo "âŒ Clippy failed"
              failed=1
            fi
            
            if [ "${{ needs.fmt.result }}" == "failure" ]; then
              echo "âŒ Format check failed"
              failed=1
            fi
            
            if [ "${{ needs.build.result }}" == "failure" ]; then
              echo "âŒ Build failed"
              failed=1
            fi
            
            if [ "${{ needs.bench.result }}" == "failure" ]; then
              echo "âŒ Benchmark check failed"
              failed=1
            fi
            
            if [ "${{ needs.coverage.result }}" == "failure" ]; then
              echo "âŒ Coverage failed"
              failed=1
            fi
            
            if [ $failed -eq 1 ]; then
              echo ""
              echo "âŒ One or more code checks failed"
              exit 1
            fi
            
            echo "âœ… All code checks passed"
          # å¦‚æœåªæœ‰æ–‡æ¡£å˜æ›´ï¼Œæ£€æŸ¥æ–‡æ¡£job
          elif [ "${{ needs.changes.outputs.docs_only }}" == "true" ]; then
            echo "ğŸ“š Documentation Changes Only - Skipping code checks"
            
            if [ "${{ needs.docs-check.result }}" == "failure" ]; then
              echo "âŒ Documentation check failed"
              exit 1
            fi
            
            echo "âœ… Documentation check passed"
          else
            echo "â„¹ï¸  No changes detected or mixed changes"
          fi
          
          echo ""
          echo "ğŸ‰ CI pipeline completed successfully!"
